#target bridge

main();

function main(){
    var script = "genBridgeTalkMsg()";
    var interval = 0;
    while(true){
        interval = prompt("Input save interval(min)", 10);
        if(interval === null) {
            alert("quit!");
            return;
        }
        if(interval > 0){
            interval *= 1000*60;
            break;
        }
    }
    alert("DON'T QUIT BRIDGE, or stop auto saving.\nand NOTE DISK FREE SPACE.\n\n\nSave each open file as other file every " +
      (interval/(60*1000)) +
      " min.\nIf you want to stop this script, kill or restart Bridge.");

    app.scheduleTask(script, interval, true);
}

function genBridgeTalkMsg() {
    var status = BridgeTalk.getStatus("illustrator");
    if(status == "IDLE"){
        var bt = new BridgeTalk();
        bt.target = "illustrator";
        bt.body = delegateSave();
        bt.send();
    }
}

function delegateSave(){
    return "var docs = app.documents;for(var i=0; i<docs.length; i++){if(docs[i].fullName.toString().lastIndexOf('/') === 0 || docs[i].fullName.toString().indexOf('.') === -1){var dir = Folder.selectDialog('Select directory');if(dir === null) continue;var opt = new IllustratorSaveOptions();opt.pdfCompatible = true;opt.embedLinkedFiles = false;opt.embedICCProfile = true;opt.compressed = false;docs[i].saveAs(new File(dir + '/' + docs[i].name + '.ai'), opt);}var docFullName = docs[i].name;var docName = docFullName.substring(0, docs[i].name.lastIndexOf('.'));var docPath = docs[i].fullName.toString().substring(0, docs[i].fullName.toString().lastIndexOf('/')+1) + docFullName;var folderPath = docPath.substring(0, docPath.length-docFullName.length) + docName + '_autosave';var folderObj = new Folder(folderPath);var date = new Date();var newDocPath = folderPath + '/' + docName + '$' +date.getFullYear().toString() + ('0'+(date.getMonth()+1)).slice(-2) + ('0'+date.getDate()).slice(-2) +('0'+date.getHours()).slice(-2) + ('0'+date.getMinutes()).slice(-2) + '.ai';if(!folderObj.exists) folderObj.create();docs[i].save();var f = new File(newDocPath);f.open('w');f.write('');f.close();new File(docPath).copy(newDocPath);}";
}